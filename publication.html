<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Publications</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <!-- Firebase v9 compat (pour utiliser firebase.firestore() et firebase.initializeApp()) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2>📰 Dernières publications</h2>
  <div id="publications-container"></div>

  <a href="index.html">
    <button style="margin-top: 20px;">🏠 Retour à l'accueil</button>
  </a>

  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDPavrp_mfV0POiDF3V4ZOZ0SHZGwgTmGs",
      authDomain: "serit-societe.firebaseapp.com",
      projectId: "serit-societe",
      storageBucket: "serit-societe.appspot.com", // ✅ corrigé ici
      messagingSenderId: "25581120285",
      appId: "1:25581120285:web:b8ee391fabf3d626480ff4"
    };

    // Initialisation
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const container = document.getElementById('publications-container');

    function renderPublication(id, data) {
      const div = document.createElement('div');
      div.className = "publication";

      // ✅ Utilisation correcte de imageUrl (minuscule)
      const imageHTML = data.imageUrl
        ? `<img src="${data.imageUrl}" alt="Publication" style="max-width: 100%; height: auto;">`
        : '';

      div.innerHTML = `
        <h3>${data.titre}</h3>
        ${imageHTML}
        <p>${data.contenu}</p>
        <small>🗓️ Publié le : ${new Date(data.date).toLocaleDateString()}</small><br>
        <button onclick="aimer('${id}')">👍 J’aime (<span id="like-${id}">${data.likes || 0}</span>)</button>
        
        <div style="margin-top:10px;">
          <input type="text" id="commentaire-${id}" placeholder="Ajouter un commentaire">
          <button onclick="commenter('${id}')">Commenter</button>
          <ul id="liste-commentaires-${id}"></ul>
        </div>
        <hr>
      `;
      container.appendChild(div);

      // Afficher les commentaires existants
      if (data.commentaires) {
        const liste = document.getElementById(`liste-commentaires-${id}`);
        data.commentaires.forEach(c => {
          const li = document.createElement('li');
          li.textContent = c;
          liste.appendChild(li);
        });
      }
    }

    // Affichage des publications
    db.collection("publications").orderBy("date", "desc").onSnapshot(snapshot => {
      container.innerHTML = "";
      snapshot.forEach(doc => {
        renderPublication(doc.id, doc.data());
      });
    });

    // J’aime
    function aimer(id) {
      const ref = db.collection("publications").doc(id);
      ref.update({
        likes: firebase.firestore.FieldValue.increment(1)
      });
    }

    // Commentaire
    function commenter(id) {
      const input = document.getElementById(`commentaire-${id}`);
      const texte = input.value.trim();
      if (texte) {
        const ref = db.collection("publications").doc(id);
        ref.update({
          commentaires: firebase.firestore.FieldValue.arrayUnion(texte)
        });
        input.value = "";
      }
    }
  </script>
</body>
  </html>
